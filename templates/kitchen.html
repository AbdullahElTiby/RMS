{% extends "base.html" %}

{% block title %}Kitchen Display System - RMS{% endblock %}

{% block extra_head %}
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%) !important;
            color: white !important;
            min-height: 100vh;
        }
        .page-content {
            max-width: 1800px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%) !important;
            color: white !important;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }
        .header h1 {
            color: #fff;
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(108, 117, 125, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #000;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 193, 7, 0.4);
        }
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 25px;
        }
        .order-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .order-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .order-id {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
        .order-type {
            background: linear-gradient(135deg, #444 0%, #555 100%);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .order-time {
            color: #bbb;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .order-table {
            margin-bottom: 15px;
            color: #ddd;
            font-weight: 500;
        }
        .order-notes {
            background: linear-gradient(135deg, #333 0%, #444 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 3px solid #667eea;
        }
        .order-items {
            margin-bottom: 25px;
        }
        .order-item {
            padding: 15px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #333 0%, #444 100%);
            border-radius: 8px;
            border-left: 4px solid #666;
            transition: all 0.3s ease;
        }
        .order-item:hover {
            background: linear-gradient(135deg, #444 0%, #555 100%);
        }
        .item-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .item-quantity {
            color: #667eea;
            font-weight: 700;
            font-size: 14px;
        }
        .item-instructions {
            color: #aaa;
            font-size: 13px;
            margin-top: 8px;
            font-style: italic;
        }
        .item-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        .status-confirmed {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }
        .status-cooking {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #000;
        }
        .status-ready {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .status-served {
            background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
        }
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .filter-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-controls select {
            padding: 10px 12px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            background: linear-gradient(135deg, #333 0%, #444 100%);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .filter-controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        .filter-controls label {
            font-weight: 600;
            color: #ddd;
            font-size: 14px;
        }
        .stats-bar {
            display: flex;
            gap: 25px;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            flex-wrap: wrap;
        }
        .stat {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #bbb;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .auto-refresh label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #ddd;
            cursor: pointer;
        }
        .auto-refresh input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        .urgent {
            border-left-color: #dc3545 !important;
            animation: urgentPulse 2s infinite;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
        }
        .urgent::before {
            background: linear-gradient(90deg, #dc3545, #ff6b6b);
        }
        @keyframes urgentPulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #bbb;
            font-size: 16px;
        }
        .no-orders {
            text-align: center;
            padding: 60px 20px;
            color: #bbb;
            font-size: 18px;
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 12px;
            border: 2px dashed rgba(102, 126, 234, 0.3);
        }
        .no-orders::before {
            content: '🎉';
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="header">
        <h1 data-i18n="kitchen_display">Kitchen Display System</h1>
        <div style="display:flex; align-items:center; gap:10px;">
            <a href="/dashboard" class="btn btn-secondary" data-i18n="back_to_dashboard">Back to Dashboard</a>
            <button class="btn btn-primary" onclick="refreshOrders()" data-i18n="refresh_orders">Refresh Orders</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="pendingOrders">0</div>
            <div class="stat-label" data-i18n="pending_orders">Pending Orders</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="cookingOrders">0</div>
            <div class="stat-label" data-i18n="cooking">Cooking</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="readyOrders">0</div>
            <div class="stat-label" data-i18n="ready_to_serve">Ready to Serve</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label" data-i18n="total_today">Total Today</div>
        </div>
    </div>

    <div class="filter-controls">
        <div>
            <label data-i18n="filter_by_status">Filter by Status:</label>
            <select id="statusFilter" onchange="filterOrders()">
                <option value="all" data-i18n="all_orders">All Orders</option>
                <option value="pending" data-i18n="pending">Pending</option>
                <option value="cooking" data-i18n="cooking">Cooking</option>
                <option value="ready" data-i18n="ready">Ready</option>
            </select>
        </div>
        <div>
            <label data-i18n="sort_by">Sort by:</label>
            <select id="sortFilter" onchange="filterOrders()">
                <option value="newest" data-i18n="newest_first">Newest First</option>
                <option value="oldest" data-i18n="oldest_first">Oldest First</option>
                <option value="urgent" data-i18n="most_urgent">Most Urgent</option>
            </select>
        </div>
        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="autoRefresh" checked>
                <span data-i18n="auto_refresh">Auto Refresh (30s)</span>
            </label>
        </div>
    </div>

    <div class="orders-grid" id="ordersGrid">
        <!-- Orders will be loaded here -->
    </div>
    <div id="loading" style="text-align: center; padding: 40px; color: #666;" data-i18n="loading_kitchen_orders">Loading kitchen orders...</div>
    <div id="noOrders" class="no-orders" style="display: none;" data-i18n="no_orders_kitchen">
        No orders in the kitchen. Everything is caught up! 🎉
    </div>
</div>

<script>
    let refreshInterval;
    let allOrders = [];

    async function checkAuth() {
        if (!localStorage.getItem('user')) {
            window.location.href = '/login';
            return false;
        }
        return true;
    }

    async function loadKitchenOrders() {
        if (!await checkAuth()) return;
        
        try {
            const response = await fetch('/api/kitchen/orders');
            const orders = await response.json();
            allOrders = orders;
            updateStats(orders);
            filterOrders();
        } catch (error) {
            console.error('Error loading kitchen orders:', error);
            const lang = localStorage.getItem('lang') || 'en';
            const dict = translations[lang] || translations.en;
            document.getElementById('loading').textContent = dict.failed_to_load || 'Failed to load orders.';
        }
    }

    function updateStats(orders) {
        const pending = orders.filter(o => o.status === 'pending').length;
        const cooking = orders.filter(o => o.status === 'cooking').length;
        const ready = orders.filter(o => o.status === 'ready').length;
        
        document.getElementById('pendingOrders').textContent = pending;
        document.getElementById('cookingOrders').textContent = cooking;
        document.getElementById('readyOrders').textContent = ready;
        document.getElementById('totalOrders').textContent = orders.length;
    }

    function filterOrders() {
        const statusFilter = document.getElementById('statusFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;
        
        let filteredOrders = allOrders;
        
        if (statusFilter !== 'all') {
            filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
        }
        
        // Sort orders
        if (sortFilter === 'newest') {
            filteredOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sortFilter === 'oldest') {
            filteredOrders.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        } else if (sortFilter === 'urgent') {
            filteredOrders.sort((a, b) => {
                // Prioritize older orders and ready status
                const aPriority = (a.status === 'ready' ? 3 : a.status === 'cooking' ? 2 : 1) + 
                                 (new Date() - new Date(a.created_at)) / 60000; // minutes waiting
                const bPriority = (b.status === 'ready' ? 3 : b.status === 'cooking' ? 2 : 1) + 
                                 (new Date() - new Date(b.created_at)) / 60000;
                return bPriority - aPriority;
            });
        }
        
        displayOrders(filteredOrders);
    }

    function displayOrders(orders) {
        const grid = document.getElementById('ordersGrid');
        const loading = document.getElementById('loading');
        const noOrders = document.getElementById('noOrders');
        
        grid.innerHTML = '';
        
        if (orders.length === 0) {
            loading.style.display = 'none';
            noOrders.style.display = 'block';
            return;
        }
        
        noOrders.style.display = 'none';
        loading.style.display = 'none';
        
        orders.forEach(order => {
            const isUrgent = (new Date() - new Date(order.created_at)) > 15 * 60 * 1000; // 15+ minutes old
            const orderCard = `
                <div class="order-card ${isUrgent ? 'urgent' : ''}">
                    <div class="order-header">
                        <div class="order-id">${t('order')} #${order.id}</div>
                        <div class="order-type">${order.order_type.toUpperCase()}</div>
                    </div>
                    <div class="order-time">${t('placed')}: ${new Date(order.created_at).toLocaleString()}</div>
                    ${order.table_number ? `<div class="order-table">${t('table')}: ${order.table_number}</div>` : ''}
                    ${order.notes ? `<div class="order-notes">📝 ${order.notes}</div>` : ''}
                    
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <div class="item-name">${item.menu_item_name}</div>
                                <div class="item-quantity">${t('qty')}: ${item.quantity}</div>
                                ${item.special_instructions ? `<div class="item-instructions">💡 ${item.special_instructions}</div>` : ''}
                                <div class="item-status">
                                    <span class="status-badge status-${item.status}">${t(item.status) || item.status}</span>
                                    <div class="action-buttons">
                                        ${item.status === 'pending' ? `
                                            <button class="btn btn-warning" onclick="updateItemStatus(${item.id}, 'cooking')">${t('start_cooking')}</button>
                                        ` : ''}
                                        ${item.status === 'cooking' ? `
                                            <button class="btn btn-success" onclick="updateItemStatus(${item.id}, 'ready')">${t('mark_ready')}</button>
                                        ` : ''}
                                        ${item.status === 'ready' ? `
                                            <button class="btn btn-primary" onclick="updateItemStatus(${item.id}, 'served')">${t('mark_served')}</button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="updateOrderStatus(${order.id}, 'completed')">${t('complete_order')}</button>
                        <button class="btn btn-secondary" onclick="updateOrderStatus(${order.id}, 'cancelled')">${t('cancel_order')}</button>
                    </div>
                </div>
            `;
            grid.innerHTML += orderCard;
        });
    }

    async function updateItemStatus(itemId, newStatus) {
        try {
            const response = await fetch(`/api/kitchen/items/${itemId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (response.ok) {
                loadKitchenOrders();
            } else {
                alert('Failed to update item status.');
            }
        } catch (error) {
            console.error('Error updating item status:', error);
        }
    }

    async function updateOrderStatus(orderId, newStatus) {
        try {
            const response = await fetch(`/api/orders/${orderId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (response.ok) {
                loadKitchenOrders();
            } else {
                alert('Failed to update order status.');
            }
        } catch (error) {
            console.error('Error updating order status:', error);
        }
    }

    function refreshOrders() {
        loadKitchenOrders();
    }

    function setupAutoRefresh() {
        const autoRefresh = document.getElementById('autoRefresh');
        
        if (autoRefresh.checked) {
            refreshInterval = setInterval(loadKitchenOrders, 30000); // Refresh every 30 seconds
        } else {
            clearInterval(refreshInterval);
        }
    }

    // i18n
    const translations = {
        en: { kitchen_display: 'Kitchen Display System', language: 'Language', back_to_dashboard: 'Back to Dashboard', refresh_orders: 'Refresh Orders', pending_orders: 'Pending Orders', cooking: 'Cooking', ready_to_serve: 'Ready to Serve', total_today: 'Total Today', filter_by_status: 'Filter by Status:', all_orders: 'All Orders', pending: 'Pending', ready: 'Ready', sort_by: 'Sort by:', newest_first: 'Newest First', oldest_first: 'Oldest First', most_urgent: 'Most Urgent', auto_refresh: 'Auto Refresh (30s)', loading_kitchen_orders: 'Loading kitchen orders...', no_orders_kitchen: 'No orders in the kitchen. Everything is caught up! 🎉', order: 'Order', placed: 'Placed', table: 'Table', qty: 'Qty', start_cooking: 'Start Cooking', mark_ready: 'Mark Ready', mark_served: 'Mark Served', complete_order: 'Complete Order', cancel_order: 'Cancel Order' },
        ar: { kitchen_display: 'نظام عرض المطبخ', language: 'اللغة', back_to_dashboard: 'العودة للوحة التحكم', refresh_orders: 'تحديث الطلبات', pending_orders: 'طلبات قيد الانتظار', cooking: 'قيد الطهي', ready_to_serve: 'جاهز للتقديم', total_today: 'الإجمالي اليوم', filter_by_status: 'تصفية حسب الحالة:', all_orders: 'كل الطلبات', pending: 'قيد الانتظار', ready: 'جاهز', sort_by: 'ترتيب حسب:', newest_first: 'الأحدث أولاً', oldest_first: 'الأقدم أولاً', most_urgent: 'الأكثر إلحاحًا', auto_refresh: 'تحديث تلقائي (30ث)', loading_kitchen_orders: 'جاري تحميل طلبات المطبخ...', no_orders_kitchen: 'لا توجد طلبات في المطبخ. كل شيء جاهز! 🎉', order: 'طلب', placed: 'تم الإنشاء', table: 'الطاولة', qty: 'الكمية', start_cooking: 'بدء الطهي', mark_ready: 'وضع كجاهز', mark_served: 'وضع كمُقدَّم', complete_order: 'إكمال الطلب', cancel_order: 'إلغاء الطلب' },
        tr: { kitchen_display: 'Mutfak Ekranı', language: 'Dil', back_to_dashboard: 'Panele Dön', refresh_orders: 'Siparişleri Yenile', pending_orders: 'Bekleyen Siparişler', cooking: 'Pişiriliyor', ready_to_serve: 'Servise Hazır', total_today: 'Bugün Toplam', filter_by_status: 'Duruma Göre Filtrele:', all_orders: 'Tüm Siparişler', pending: 'Beklemede', ready: 'Hazır', sort_by: 'Sırala:', newest_first: 'En Yeni', oldest_first: 'En Eski', most_urgent: 'En Acil', auto_refresh: 'Otomatik Yenile (30 sn)', loading_kitchen_orders: 'Mutfak siparişleri yükleniyor...', no_orders_kitchen: 'Mutfakta sipariş yok. Her şey tamam! 🎉', order: 'Sipariş', placed: 'Oluşturuldu', table: 'Masa', qty: 'Adet', start_cooking: 'Pişirmeye Başla', mark_ready: 'Hazır Olarak İşaretle', mark_served: 'Servis Edildi Olarak İşaretle', complete_order: 'Siparişi Tamamla', cancel_order: 'Siparişi İptal Et' }
    };
    function t(key){ const lang = localStorage.getItem('lang') || 'en'; return (translations[lang]||translations.en)[key]||key; }
    function applyTranslations(lang) {
        const dict = translations[lang] || translations.en;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (dict[key]) el.textContent = dict[key];
        });
        document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        document.body.style.textAlign = (lang === 'ar') ? 'right' : 'left';
    }
    function initI18n() {
        const saved = localStorage.getItem('lang') || 'en';
        const select = document.getElementById('langSelect');
        if (select) {
            select.value = saved;
            select.addEventListener('change', () => {
                const lang = select.value;
                localStorage.setItem('lang', lang);
                applyTranslations(lang);
                loadKitchenOrders();
            });
        }
        applyTranslations(saved);
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        initI18n();
        loadKitchenOrders();
        setupAutoRefresh();
        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);
    });
</script>
{% endblock %}
