{% extends "base.html" %}

{% block title %}AI Assistant - RMS{% endblock %}

{% block extra_head %}
    <style>
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        .header h1 { color: #333; margin: 0; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; font-size: 14px; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .ai-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .ai-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; }
        .ai-card h3 { margin-top: 0; color: #495057; }
        .ai-card p { color: #6c757d; margin-bottom: 15px; }
        .result-box { background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; padding: 15px; margin-top: 15px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .loading { text-align: center; padding: 20px; color: #6c757d; }
        .error { color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; margin-top: 10px; }
        .success { color: #155724; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 10px; margin-top: 10px; }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="header">
            <h1 data-i18n="ai_assistant_title">🤖 AI Restaurant Assistant</h1>
            <div style="display:flex; align-items:center; gap:10px;">
                <label for="langSelect" data-i18n="language">Language</label>
                <select id="langSelect">
                    <option value="en">English</option>
                    <option value="ar">العربية</option>
                    <option value="tr">Türkçe</option>
                </select>
                <a href="/dashboard" class="btn btn-secondary" data-i18n="back_to_dashboard">Back to Dashboard</a>
            </div>
        </div>

        <div class="ai-grid">
            <!-- Inventory Insights -->
            <div class="ai-card">
                <h3 data-i18n="inventory_insights_title">📊 Inventory Insights</h3>
                <p data-i18n="inventory_insights_desc">Analyze your inventory levels, usage patterns, and get smart recommendations for stock management.</p>
                <button class="btn btn-primary" onclick="getInventoryInsights()" data-i18n="get_insights">Get Insights</button>
                <div id="insights-result" class="result-box" style="display: none;"></div>
            </div>

            <!-- Menu Suggestions -->
            <div class="ai-card">
                <h3 data-i18n="menu_suggestions_title">🍽️ Menu Suggestions</h3>
                <p data-i18n="menu_suggestions_desc">Get AI-powered menu recommendations based on your current inventory and seasonal trends.</p>
                <button class="btn btn-success" onclick="getMenuSuggestions()" data-i18n="get_suggestions">Get Suggestions</button>
                <div id="menu-result" class="result-box" style="display: none;"></div>
            </div>

            <!-- Demand Prediction -->
            <div class="ai-card">
                <h3 data-i18n="demand_prediction_title">🔮 Demand Prediction</h3>
                <p data-i18n="demand_prediction_desc">Predict ingredient demand for the next few days based on historical usage patterns.</p>
                <label for="days-ahead" data-i18n="days_ahead">Days ahead:</label>
                <select id="days-ahead" style="margin-left: 10px; padding: 5px;">
                    <option value="3" data-i18n="3_days">3 days</option>
                    <option value="7" selected data-i18n="7_days">7 days</option>
                    <option value="14" data-i18n="14_days">14 days</option>
                    <option value="30" data-i18n="30_days">30 days</option>
                </select>
                <br><br>
                <button class="btn btn-warning" onclick="getDemandPrediction()" data-i18n="predict_demand">Predict Demand</button>
                <div id="demand-result" class="result-box" style="display: none;"></div>
            </div>

            <!-- Inventory Optimization -->
            <div class="ai-card">
                <h3 data-i18n="inventory_optimization_title">⚡ Inventory Optimization</h3>
                <p data-i18n="inventory_optimization_desc">Get recommendations for optimizing your inventory turnover, reducing waste, and improving efficiency.</p>
                <button class="btn btn-info" onclick="getInventoryOptimization()" data-i18n="optimize_inventory">Optimize Inventory</button>
                <div id="optimization-result" class="result-box" style="display: none;"></div>
            </div>
        </div>

        <!-- AI Chat Section -->
        <div class="ai-card" style="grid-column: 1 / -1;">
            <h3 data-i18n="ai_chat_title">💬 AI Restaurant Chat</h3>
            <p data-i18n="ai_chat_desc">Ask me anything about your restaurant operations, inventory, menu planning, or business optimization!</p>

            <div id="chat-messages" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                <div class="message ai-message">
                    <strong id="aiAssistantLabel">AI Assistant:</strong> <span id="aiWelcomeText">Hello! I'm your restaurant AI assistant. I can help you with inventory management, menu planning, demand forecasting, and business optimization. What would you like to know?</span>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Ask me anything about your restaurant..." style="flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;" data-i18n-placeholder="chat_placeholder">
                <button class="btn btn-primary" onclick="sendChatMessage()" data-i18n="send">Send</button>
            </div>

            <div style="margin-top: 10px;">
                <small style="color: #6c757d;" data-i18n="chat_examples">Try asking: "What's my best-selling item this month?" or "How can I reduce food waste?"</small>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // i18n translations for AI page
    const translations = {
        en: { ai_assistant_title: '🤖 AI Restaurant Assistant', inventory_insights_title: '📊 Inventory Insights', inventory_insights_desc: 'Analyze your inventory levels, usage patterns, and get smart recommendations for stock management.', get_insights: 'Get Insights', menu_suggestions_title: '🍽️ Menu Suggestions', menu_suggestions_desc: 'Get AI-powered menu recommendations based on your current inventory and seasonal trends.', get_suggestions: 'Get Suggestions', demand_prediction_title: '🔮 Demand Prediction', demand_prediction_desc: 'Predict ingredient demand for the next few days based on historical usage patterns.', days_ahead: 'Days ahead:', '3_days': '3 days', '7_days': '7 days', '14_days': '14 days', '30_days': '30 days', predict_demand: 'Predict Demand', inventory_optimization_title: '⚡ Inventory Optimization', inventory_optimization_desc: 'Get recommendations for optimizing your inventory turnover, reducing waste, and improving efficiency.', optimize_inventory: 'Optimize Inventory', ai_chat_title: '💬 AI Restaurant Chat', ai_chat_desc: 'Ask me anything about your restaurant operations, inventory, menu planning, or business optimization!', chat_placeholder: 'Ask me anything about your restaurant...', send: 'Send', chat_examples: 'Try asking: "What\'s my best-selling item this month?" or "How can I reduce food waste?"', language: 'Language', back_to_dashboard: 'Back to Dashboard', analyzing: 'AI is analyzing...', ai: 'AI:', you: 'You:', welcome: 'Hello! I\'m your restaurant AI assistant. I can help you with inventory management, menu planning, demand forecasting, and business optimization. What would you like to know?' },
        ar: { ai_assistant_title: '🤖 مساعد المطعم الذكي', inventory_insights_title: '📊 تحليلات المخزون', inventory_insights_desc: 'حلل مستويات مخزونك وأنماط الاستخدام واحصل على توصيات ذكية لإدارة المخزون.', get_insights: 'الحصول على التحليلات', menu_suggestions_title: '🍽️ اقتراحات القائمة', menu_suggestions_desc: 'احصل على توصيات قائمة مدعومة بالذكاء الاصطناعي بناءً على مخزونك الحالي والاتجاهات الموسمية.', get_suggestions: 'الحصول على الاقتراحات', demand_prediction_title: '🔮 توقع الطلب', demand_prediction_desc: 'توقع الطلب على المكونات للأيام القادمة بناءً على أنماط الاستخدام التاريخية.', days_ahead: 'الأيام المقبلة:', '3_days': '3 أيام', '7_days': '7 أيام', '14_days': '14 يوم', '30_days': '30 يوم', predict_demand: 'توقع الطلب', inventory_optimization_title: '⚡ تحسين المخزون', inventory_optimization_desc: 'احصل على توصيات لتحسين دوران المخزون وتقليل الهدر وتحسين الكفاءة.', optimize_inventory: 'تحسين المخزون', ai_chat_title: '💬 دردشة المطعم الذكية', ai_chat_desc: 'اسألني أي شيء عن عمليات مطعمك ومخزونك وتخطيط القائمة أو تحسين الأعمال!', chat_placeholder: 'اسألني أي شيء عن مطعمك...', send: 'إرسال', chat_examples: 'جرب السؤال: "ما هو أكثر أصنافي مبيعًا هذا الشهر؟" أو "كيف يمكنني تقليل هدر الطعام؟"', language: 'اللغة', back_to_dashboard: 'العودة للوحة التحكم', analyzing: 'الذكاء الاصطناعي يحلل...', ai: 'الذكاء الاصطناعي:', you: 'أنت:', welcome: 'مرحبا! أنا مساعدك الذكي للمطعم. يمكنني مساعدتك في إدارة المخزون وتخطيط القائمة وتوقع الطلب وتحسين الأعمال. ماذا تريد أن تعرف؟' },
        tr: { ai_assistant_title: '🤖 AI Restoran Asistanı', inventory_insights_title: '📊 Stok Analizleri', inventory_insights_desc: 'Stok seviyelerinizi, kullanım paternlerinizi analiz edin ve stok yönetimi için akıllı öneriler alın.', get_insights: 'Analizleri Al', menu_suggestions_title: '🍽️ Menü Önerileri', menu_suggestions_desc: 'Mevcut stokunuz ve mevsimsel trendlere dayalı AI destekli menü önerileri alın.', get_suggestions: 'Önerileri Al', demand_prediction_title: '🔮 Talep Tahmini', demand_prediction_desc: 'Tarihsel kullanım paternlerine dayanarak gelecek günlerdeki malzeme talebini tahmin edin.', days_ahead: 'Günler ilerisi:', '3_days': '3 gün', '7_days': '7 gün', '14_days': '14 gün', '30_days': '30 gün', predict_demand: 'Talebi Tahmin Et', inventory_optimization_title: '⚡ Stok Optimizasyonu', inventory_optimization_desc: 'Stok devir hızınızı optimize etmek, atıkları azaltmak ve verimliliği artırmak için öneriler alın.', optimize_inventory: 'Stoğu Optimize Et', ai_chat_title: '💬 AI Restoran Sohbeti', ai_chat_desc: 'Restoran operasyonlarınız, stokunuz, menü planlamanız veya iş optimizasyonunuz hakkında herhangi bir şey sorun!', chat_placeholder: 'Restoranınız hakkında herhangi bir şey sorun...', send: 'Gönder', chat_examples: 'Şunu sorun: "Bu ay en çok satan ürünüm nedir?" veya "Gıda israfını nasıl azaltabilirim?"', language: 'Dil', back_to_dashboard: 'Panele Dön', analyzing: 'AI analiz ediyor...', ai: 'AI:', you: 'Sen:', welcome: 'Merhaba! Restoran AI asistanınızım. Stok yönetimi, menü planlama, talep tahmini ve iş optimizasyonunda size yardımcı olabilirim. Ne öğrenmek istersiniz?' }
    };

    function applyTranslations(lang) {
        const dict = translations[lang] || translations.en;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (dict[key]) {
                if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                    el.placeholder = dict[key];
                } else {
                    el.textContent = dict[key];
                }
            }
        });
        document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        document.body.style.textAlign = (lang === 'ar') ? 'right' : 'left';
    }

    function initI18n() {
        const saved = localStorage.getItem('lang') || 'en';
        const select = document.getElementById('langSelect');
        if (select) {
            select.value = saved;
            select.addEventListener('change', () => {
                const lang = select.value;
                localStorage.setItem('lang', lang);
                applyTranslations(lang);
            });
        }
        applyTranslations(saved);
    }

    async function checkAuth() {
        if (!localStorage.getItem('user')) {
            window.location.href = '/login';
            return false;
        }
        return true;
    }

    async function makeAIRequest(endpoint, resultElementId) {
        if (!await checkAuth()) return;

        const resultDiv = document.getElementById(resultElementId);
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="loading">🤖 AI is analyzing your data...</div>';

        try {
            // Add language parameter to the endpoint
            const currentLang = localStorage.getItem('lang') || 'en';
            const url = new URL(endpoint, window.location.origin);
            url.searchParams.set('lang', currentLang);

            const response = await fetch(url.toString());
            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = `<div class="success">${data.insights || data.suggestions || data.prediction || data.optimization}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
        }
    }

    async function getInventoryInsights() {
        await makeAIRequest('/api/ai/inventory-insights', 'insights-result');
    }

    async function getMenuSuggestions() {
        await makeAIRequest('/api/ai/menu-suggestions', 'menu-result');
    }

    async function getDemandPrediction() {
        const days = document.getElementById('days-ahead').value;
        await makeAIRequest(`/api/ai/demand-prediction?days=${days}`, 'demand-result');
    }

    async function getInventoryOptimization() {
        await makeAIRequest('/api/ai/optimize-inventory', 'optimization-result');
    }

    async function sendChatMessage() {
        if (!await checkAuth()) return;

        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;

        // Add user message
        addMessage('user', message);
        input.value = '';

        // Show typing indicator
        const currentLang = localStorage.getItem('lang') || 'en';
        const trans = translations[currentLang] || translations.en;
        const typingDiv = addMessage('ai', `🤖 ${trans.analyzing || 'AI is analyzing...'}`);

        try {
            // Use the actual AI service with language context
            const response = await fetch('/api/ai/context-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    context: {
                        title: 'AI Restaurant Assistant',
                        url: '/ai',
                        content: 'AI Restaurant Assistant page with features for inventory insights, menu suggestions, demand prediction, and inventory optimization.',
                        timestamp: new Date().toISOString(),
                        language: currentLang
                    }
                })
            });

            const data = await response.json();

            if (response.ok) {
                typingDiv.innerHTML = `<strong>${trans.ai || 'AI:'}</strong> ${data.response}`;
            } else {
                typingDiv.innerHTML = `<strong>${trans.ai || 'AI:'}</strong> ❌ ${data.error || 'Error occurred'}`;
            }
        } catch (error) {
            typingDiv.innerHTML = `<strong>${trans.ai || 'AI:'}</strong> ❌ ${error.message}`;
        }
    }

    function addMessage(type, content) {
        const messagesDiv = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        messageDiv.style.marginBottom = '10px';
        messageDiv.style.padding = '10px';
        messageDiv.style.borderRadius = '4px';
        messageDiv.style.background = type === 'user' ? '#007bff' : '#e9ecef';
        messageDiv.style.color = type === 'user' ? 'white' : 'black';

        const currentLang = localStorage.getItem('lang') || 'en';
        const trans = translations[currentLang] || translations.en;

        if (type === 'user') {
            messageDiv.innerHTML = `<strong>${trans.you || 'You:'}</strong> ${content}`;
        } else {
            messageDiv.innerHTML = content;
        }

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return messageDiv;
    }

    async function simulateAIResponse(message) {
        // Simulate AI processing time
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));

        // Simple response logic - in a real app, this would call an AI API
        const lowerMessage = message.toLowerCase();

        if (lowerMessage.includes('inventory') || lowerMessage.includes('stock')) {
            return "I can help you with inventory management! Try using the 'Inventory Insights' feature above to get detailed analysis of your stock levels and recommendations.";
        } else if (lowerMessage.includes('menu') || lowerMessage.includes('food')) {
            return "For menu-related questions, I recommend checking the 'Menu Suggestions' feature. It can help you optimize your menu based on current inventory and customer preferences.";
        } else if (lowerMessage.includes('sales') || lowerMessage.includes('revenue')) {
            return "I can analyze your sales data! Check the Reports section in your dashboard for detailed sales analytics and trends.";
        } else if (lowerMessage.includes('waste') || lowerMessage.includes('reduce')) {
            return "To reduce food waste, focus on accurate demand forecasting and portion control. The 'Inventory Optimization' feature can provide specific recommendations for your restaurant.";
        } else {
            return "I'm here to help with restaurant management! I can assist with inventory analysis, menu planning, demand forecasting, and business optimization. What specific area would you like help with?";
        }
    }

    // Add enter key support for chat
    document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        if (!await checkAuth()) return;

        // Initialize i18n
        initI18n();

        // Add welcome message
        setTimeout(() => {
            const currentLang = localStorage.getItem('lang') || 'en';
            const trans = translations[currentLang] || translations.en;
            addMessage('ai', `<strong>${trans.ai || 'AI:'}</strong> ${trans.welcome || 'Hello! I\'m your restaurant AI assistant. I can help you with inventory management, menu planning, demand forecasting, and business optimization. What would you like to know?'}`);
        }, 1000);
    });
</script>
{% endblock %}
